clc;

%% ====================================================================
%% IEEE 33节点R-SOP系统基础数据定义
%% 对应原case33_R_SOP.m的静态数据部分
%% ====================================================================

%% 1. 系统基本参数
version = '3';                                   % 版本号，对应mpc.version
baseMVA = 1;                                     % 系统基准容量 (MVA)
baseKV = 12.66;                                  % 系统基准电压 (kV)

%% 2. 支路数据 (Branch Data) - 单位: 欧姆(Ω)
% 对应mpc.branch，注意第7行数据与原版不同
Branch = [
    1,  2,  0.0922, 0.0470, 0, 10;              % 主干线路
    2,  3,  0.4930, 0.2511, 0, 10;
    3,  4,  0.3660, 0.1864, 0, 10;
    4,  5,  0.3811, 0.1941, 0, 10;
    5,  6,  0.8190, 0.7070, 0, 10;
    6,  7,  0.1872, 0.6188, 0, 10;
    7,  8,  1.7114, 1.2351, 0, 10;              % 关键：与原版数值不同
    8,  9,  1.0300, 0.7400, 0, 10;
    9,  10, 1.0400, 0.7400, 0, 10;
    10, 11, 0.1966, 0.0650, 0, 10;
    11, 12, 0.3744, 0.1238, 0, 10;
    12, 13, 1.4680, 1.1550, 0, 10;
    13, 14, 0.5416, 0.7129, 0, 10;
    14, 15, 0.5910, 0.5260, 0, 10;
    15, 16, 0.7463, 0.5450, 0, 10;
    16, 17, 1.2890, 1.7210, 0, 10;
    17, 18, 0.7320, 0.5740, 0, 10;
    2,  19, 0.1640, 0.1565, 0, 10;              % 分支1
    19, 20, 1.5042, 1.3554, 0, 10;
    20, 21, 0.4095, 0.4784, 0, 10;
    21, 22, 0.7089, 0.9373, 0, 10;
    3,  23, 0.4512, 0.3083, 0, 10;              % 分支2
    23, 24, 0.8980, 0.7091, 0, 10;
    24, 25, 0.8960, 0.7011, 0, 10;
    6,  26, 0.2030, 0.1034, 0, 10;              % 分支3
    26, 27, 0.2842, 0.1447, 0, 10;
    27, 28, 1.0590, 0.9337, 0, 10;
    28, 29, 0.8042, 0.7006, 0, 10;
    29, 30, 0.5075, 0.2585, 0, 10;
    30, 31, 0.9744, 0.9630, 0, 10;
    31, 32, 0.3105, 0.3619, 0, 10;
    32, 33, 0.3410, 0.5302, 0, 10;
];

%% 3. 基础负荷数据定义
% 对应mpc.load_3ph_kW的原始数据
load_data_total = [
    100, 60; 90, 40; 120, 80; 60, 30; 60, 20; 200, 100; 200, 100;
    60, 20; 60, 20; 45, 30; 60, 35; 60, 35; 120, 80; 60, 10; 60, 20;
    60, 20; 90, 40; 90, 40; 90, 40; 90, 40; 90, 40; 90, 40; 90, 40;
    420, 200; 420, 200; 60, 25; 60, 25; 60, 20; 120, 70; 200, 600;
    150, 70; 210, 100; 60, 40
];

%% 4. 负荷缩放系数
P_scale = 3635 / sum(load_data_total(:,1));     % 有功负荷缩放系数
Q_scale = 2265 / sum(load_data_total(:,2));     % 无功负荷缩放系数
load_data_scaled = load_data_total .* [P_scale, Q_scale];

%% 5. 生成Bus矩阵（兼容原有格式）
Bus = zeros(33, 3);                             % [节点号, 有功负荷(kW), 无功负荷(kVar)]
Bus(:,1) = (1:33)';                             % 节点编号
Bus(1,:) = [1, 0, 0];                           % 平衡节点

% 填充负荷数据
for i = 1:32
    bus_idx = i + 1;                            % 节点编号从2开始
    Bus(bus_idx, 2) = load_data_scaled(i, 1);   % 有功负荷
    Bus(bus_idx, 3) = load_data_scaled(i, 2);   % 无功负荷
end

%% 6. 三相不平衡系数定义
% 对应case33_R_SOP.m中的特殊负荷分配逻辑
three_phase_imbalance = ones(33, 3) / 3;        % 默认三相平衡，每相1/3

% 特殊节点的不平衡设置
three_phase_imbalance(4, :) = [0, 0.5, 0.5];    % 节点4: BC相各50%
three_phase_imbalance(7, :) = [1.0, 0, 0];      % 节点7: 单A相
three_phase_imbalance(9, :) = [0, 0, 1.0];      % 节点9: 单C相
three_phase_imbalance(14, :) = [0.7, 0.3, 0];   % 节点14: A相70%，B相30%
three_phase_imbalance(24, :) = [0, 1.0, 0];     % 节点24: 单B相
three_phase_imbalance(27, :) = [0.5, 0, 0.5];   % 节点27: AC相各50%
three_phase_imbalance(31, :) = [0, 0, 1.0];     % 节点31: 单C相

%% 7. VSC可重构SOP基础配置
r_sop_id = 1;                                   % R-SOP系统ID
r_sop_vsc_num = 4;                              % VSC数量
r_sop_candidate_nodes = [12, 18, 22, 25, 29, 33]; % 候选连接节点
r_sop_vsc_capacity = 300;                       % 单个VSC容量 (kVA)
r_sop_total_capacity = r_sop_vsc_num * r_sop_vsc_capacity; % 总调节容量

% VSC损耗系数 [ca0, ca1, ca2]
r_sop_loss_coeffs = [0.01 * 300, 0.005, 0.0001];

%% 8. 储能系统基础配置
ess_id = 1;                                     % ESS编号
ess_bus = 24;                                   % 接入节点
ess_capacity_kWh = 1000;                        % 储能容量 (kWh)
ess_power_kW = 500;                             % 最大充放电功率 (kW)
ess_soc_min = 0.2;                              % 最小荷电状态
ess_soc_max = 0.9;                              % 最大荷电状态
ess_soc_init = 0.5;                             % 初始荷电状态
ess_eff_ch = 0.95;                              % 充电效率
ess_eff_dis = 0.95;                             % 放电效率

%% 9. 负荷投切基础配置
ls_id = 1;                                      % 负荷投切系统ID
ls_bus = [18, 22, 25, 33];                      % 可投切负荷节点
ls_priority = [3, 2, 2, 1];                     % 投切优先级
ls_max_shed_pct = [0.5, 0.6, 0.6, 0.8];        % 最大投切比例

%% 10. 分布式光伏基础配置
% 对应mpc.pv_3ph
pv_3ph_config = [
    4,  1, 200;   % [节点编号, 相别(1=A,2=B,3=C), 装机容量(kVA)]
    7,  3, 200;
    9,  2, 200;
    13, 1, 200;
    15, 2, 300;
    17, 3, 300;
    24, 2, 200;
    27, 3, 300;
    31, 1, 300;
];

%% 11. 输出验证信息
total_P_kW = sum(Bus(2:end, 2));                % 总有功负荷
total_Q_kvar = sum(Bus(2:end, 3));              % 总无功负荷
total_PV_kVA = sum(pv_3ph_config(:,3));         % 总光伏容量

fprintf('\n========== IEEE 33节点R-SOP系统基础数据验证 ==========\n');
fprintf('节点总数: %d\n', size(Bus,1));
fprintf('支路总数: %d\n', size(Branch,1));
fprintf('总有功负荷: %.1f kW\n', total_P_kW);
fprintf('总无功负荷: %.1f kVar\n', total_Q_kvar);
fprintf('总PV容量: %.0f kVA (渗透率: %.1f%%)\n', total_PV_kVA, total_PV_kVA / total_P_kW * 100);
fprintf('R-SOP总容量: %.0f kVA\n', r_sop_total_capacity);
fprintf('ESS容量: %.0f kWh @ 节点%d\n', ess_capacity_kWh, ess_bus);
fprintf('====================================================\n');